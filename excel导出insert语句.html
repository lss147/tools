<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>上传excel生成insert语句</title>
    <script src="xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>
</head>

<body>
    <div>上传excel生成insert语句</div>
    <input type="file" onchange="importf(this)" />
    <p>待编辑的insert语句</p>
    <input id="sqltext" type="text" placeholder="请输入sql文本！" name="" />
    <p></p>
    <input type="checkbox" id="selectAll" />全选
    <input type="checkbox" id="selectNotEmpty" />选中非空
    <button onclick="parseinsert()">解析insert</button>
    <button onclick="generateinsert()">生成选中字段的insert</button>
    <button onclick="addcolumn()">增加字段</button>
    <p id="demo"></p>
    <div id="tabs"></div>
    <script>
        /*
        FileReader共有4种读取方法：
        1.readAsArrayBuffer(file)：将文件读取为ArrayBuffer。
        2.readAsBinaryString(file)：将文件读取为二进制字符串
        3.readAsDataURL(file)：将文件读取为Data URL
        4.readAsText(file, [encoding])：将文件读取为文本，encoding缺省值为'UTF-8'
                     */
        var wb;//读取完成的数据
        var rABS = false; //是否将文件读取为二进制字符串

        function importf(obj) {//导入
            if (!obj.files) {
                return;
            }
            var file = obj.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                var data = e.target.result;
                if (rABS) {
                    wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                        type: 'base64'
                    });
                } else {
                    wb = XLSX.read(data, {
                        type: 'binary', cellDates: true 
                    });
                }
                //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
                //wb.Sheets[Sheet名]获取第一个Sheet的数据

                var columnsAndValuesjson = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                var values=" values( ";
                var columns="insert into "+file.name.replace(".xls","")+" (";
                var insertsql="";

                for (var i = 0, l = columnsAndValuesjson.length; i < l; i++) {
                    for (var key in columnsAndValuesjson[i]) {
                        columns+=key+",";
                        if(isNaN(columnsAndValuesjson[i][key])){
                            if(columnsAndValuesjson[i][key]=='null'){
                                values+=columnsAndValuesjson[i][key]+","
                            }
                            else{
                            values+="'"+columnsAndValuesjson[i][key]+"',"
                            }
                        }else{
                            if(columnsAndValuesjson[i][key] instanceof Date){
                                values+="'"+dateFormat(new Date(columnsAndValuesjson[i][key].getTime()+1000*43) )+"',"//不知道为什么解析出来的时间少了47秒，加上以后有些还是会有误差1秒
                            }else{
                                values+=columnsAndValuesjson[i][key]+","
                            }
                        }
                        //console.log(key + ':' + columnsAndValuesjson[i][key]);
                    }
                    insertsql+=columns.substring(0, columns.length - 1)+")"+values.substring(0, values.length - 1)+");";
                    columns="insert into "+file.name.replace(".xls","")+" (";
                    values=" values( ";
                }
               // $("#tabs").append("<div>生成的sql为：<input id='sqltext' type='text'  value=\"" + insertsql + "\" name='resultsql'></div>");
               document.getElementById("sqltext").value=insertsql;
                console.log(insertsql)
    
            };
            if (rABS) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function fixdata(data) { //文件流转BinaryString
            var o = "",
                l = 0,
                w = 10240;
            for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
            o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
            return o;
        }
        function dateFormat( date) {
            let fmt="YYYY-mm-dd HH:MM:SS";
            let ret;
            const opt = {
            "Y+": date.getFullYear().toString(),        // 年
            "m+": (date.getMonth() + 1).toString(),     // 月
            "d+": date.getDate().toString(),            // 日
            "H+": date.getHours().toString(),           // 时
            "M+": date.getMinutes().toString(),         // 分
            "S+": date.getSeconds().toString()          // 秒
            // 有其他格式化字符需求可以继续添加，必须转化成字符串
            };
            for (let k in opt) {
                ret = new RegExp("(" + k + ")").exec(fmt);
                if (ret) {
                    fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
                };
            };
            return fmt;
        }



      //记录添加的字段的数量
      var addid = 0;
        // //记录sql语句的数量
        // var sqlnums;
        function parseinsert() {
            var r = /(?<=\()[^\)]+(?=\))/g;
            // var sqlgroup = $("#sqltext").val().split(";")
            // sqlgroup.remove("");
            // sqlnums = sqlgroup.length;
            // if (sqlnums == 1) {
                var sql = $("#sqltext").val();
                var collumns = (sql.match(r)[0]).replace(/\"/g, "\"").split(",");
                var datas = (sql.match(r)[1]).split(",");
                var result = "";
                for (var i = 0; i < collumns.length; i++) {
                    result += "<div><label for='ckb" + i + "'><input type='checkbox' id='" + i + "'name='ckbs' >" + collumns[i] + "</label>";
                    result += "<input id='sqltext" + i + "' type='text'  name='data" + i + "' value=\"" + datas[i] + "\"></input></div>";

                }
                $("#tabs").empty().append(result);
                addid = 0
            // } else {

            // }
        }

        function addcolumn() {

            var result = "";
            result += "<div><label for='ckb'><input type='text' id='columns" + addid + "' placeholder='请输入字段名'></label>";
            result += "<input  type='text'  id='datas" + addid + "' placeholder='请输入数据'></input></div>";
            addid++;
            $("#tabs").append(result);
        }
        function generateinsert() {


            var labels = document.getElementsByTagName("input");
            var ids = [];
            for (var i = 0; i < labels.length; i++) {
                var obj = labels[i];
                //判断是否是checkbox并且已经选中
                if (obj.type == "checkbox" && obj.checked) {
                    var id = obj.id;//获取checkbox的值
                    ids.push(parseInt(id));
                }
            }
            var choosedcollumns = "";
            var chooseddatas = "";
            var r = /(?<=\()[^\)]+(?=\))/g;
            var sql = $("#sqltext").val();
            if (sql != null && sql != "") {
                var collumns = (sql.match(r)[0]).replace(/\"/g, "\"").split(",");
                var datas = (sql.match(r)[1]).split(",");

                sql = sql.replace(collumns, "字段占位").replace(datas, "数据占位")

                var result = "";
                for (var i = 0; i < collumns.length; i++) {

                    if (ids.indexOf(i) >= 0) {
                        choosedcollumns = choosedcollumns + collumns[i] + ","
                        chooseddatas = chooseddatas + $("#sqltext" + i).val() + ","
                    }
                }


            }
            if (addid > 0) {
                if (sql == null || sql == "") {
                    //循环把所有添加的字段和数据加到sql中
                    for (var i = 0; i < addid; i++) {
                        if ($("#columns" + i).val() != null && $("#columns" + i).val() != "" && $("#datas" + i).val() != null && $("#datas" + i).val() != "") {
                            choosedcollumns = choosedcollumns + $("#columns" + i).val() + ",";
                            chooseddatas = chooseddatas + $("#datas" + i).val() + ",";
                        }
                    }
                    sql = "insert into xxxxx(字段占位)values(数据占位);"
                } else {
                    //循环把所有添加的字段和数据加到sql中
                    for (var i = 0; i < addid; i++) {
                        if ($("#columns" + i).val() != null && $("#columns" + i).val() != "" && $("#datas" + i).val() != null && $("#datas" + i).val() != "") {
                            choosedcollumns = choosedcollumns + $("#columns" + i).val() + ",";
                            chooseddatas = chooseddatas + $("#datas" + i).val() + ",";
                        }
                    }
                }

            }
            choosedcollumns = choosedcollumns.substring(0, choosedcollumns.length - 1);
            chooseddatas = chooseddatas.substring(0, chooseddatas.length - 1);

            var resultsql = sql.replace("字段占位", choosedcollumns).replace("数据占位", chooseddatas)

            $("#tabs").append("<div>生成的sql为：<input id='sqltext' type='text'  value=\"" + resultsql + "\" name='resultsql'></div>");
        }


        $(function () {
            var i = 0;
            //全选
            $("#selectAll").on("click", function () {
                var labels = document.getElementsByTagName("input");
                if (document.getElementById("selectAll").checked == true) {
                    for (var i = 0; i < labels.length; i++) {
                        var obj = labels[i];
                        //判断是否是checkbox并且已经选中
                        if (obj.type == "checkbox" && obj.id != "selectAll"&& obj.id != "selectNotEmpty") {

                            obj.checked = true
                        }
                    }
                } else {
                    for (var i = 0; i < labels.length; i++) {
                        var obj = labels[i];
                        //判断是否是checkbox并且已经选中
                        if (obj.type == "checkbox" && obj.id != "selectAll"&& obj.id != "selectNotEmpty") {

                            obj.checked = false
                        }
                    }
                }
            })

        });


        $(function () {
            var i = 0;
            //全选
            $("#selectNotEmpty").on("click", function () {
                var labels = document.getElementsByTagName("input");
                if (document.getElementById("selectNotEmpty").checked == true) {
                    for (var i = 0; i < labels.length; i++) {
                        var obj = labels[i];
                        //判断是否是checkbox并且已经选中
                        if (obj.type == "checkbox" && obj.id != "selectNotEmpty"&& obj.id != "selectAll") {
                            if($("#sqltext" + obj.id).val()==null ||$("#sqltext" + obj.id).val()==""){
                                obj.checked = false
                            }
                            else{ obj.checked = true
                             
                            }
                           
                            
                        }
                    }
                } else {
                    for (var i = 0; i < labels.length; i++) {
                        var obj = labels[i];
                        //判断是否是checkbox并且已经选中
                        if (obj.type == "checkbox" && obj.id != "selectNotEmpty"&& obj.id != "selectAll") {

                            obj.checked = false
                        }
                    }
                }
            })

        });



        Array.prototype.indexOf = function (val) {
            for (var i = 0; i < this.length; i++) {
                if (this[i] == val) return i;
            }
            return -1;
        };
        Array.prototype.remove = function (val) {
            var index = this.indexOf(val);
            if (index > -1) {
                this.splice(index, 1);
            }
        };


    </script>
</body>

</html>